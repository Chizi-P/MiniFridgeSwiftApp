//
//  PostItPage.swift
//  MiniFridge
//
//  Created by üêΩ on 6/10/2020.
//  Copyright ¬© 2020 chizi. All rights reserved.
//

import SwiftUI

struct PostItPage: View {
    
    init() {
        UITableView.appearance().separatorStyle = .none
        
        //Èö±ËóèÊåâÈçµÂæåÁÅ∞Ëâ≤ÊïàÊûú
        UITableViewCell.appearance().selectionStyle = .none
        UINavigationBar.appearance().barTintColor = .white
        UINavigationBar.appearance().isTranslucent = false
        
        // ËÉåÊôØÈÄöÈÄè ËÆì background color ÂëàÁèæ
        UITableView.appearance().backgroundColor = .clear
        
        // To remove only extra separators below the list:
        UITableView.appearance().tableFooterView = UIView()
        
        // To remove all separators including the actual ones:
        UITableView.appearance().separatorStyle = .none
    }
    
    //    @AppStorage("PostIts") var postIts : Data = encodedPostIt(postItDatas)
    
    @State private var isShowOptions = false
    @State private var isShowPhotoLibraryOrCameraSheet = false
    @State private var isShowPhotoLibrary = false
    @State var edit = false
    @State var isShowShare = false
    @State var isSetting = false
    @State private var image = UIImage()
    @State private var oldImage = UIImage()
    @State private var classificationLabel : String = ""
    
    //    @State var getUserPostResult : [UserPost] = [UserPost(postID : 0, username : "0", images: "0", text: "0", create_time : "0")]
    //    @State var getAllPostIt: [PostIt] = [presetPostIt]
    
    @AppStorage("postIt") var postIt : Data = encodedPostIt([presetPostIt])
    @AppStorage("modelDatas") var modelDatas : Data = try! JSONEncoder().encode([presetModelData])
    @AppStorage("calories") var calories : Double = 0
    
    @State var DCpostIt : [PostIt] = []
    
    @AppStorage("isCreatingPostIt") var isCreatingPostIt = false
    
    // Êõ¥Êñ∞Áï´Èù¢Áî®
    @AppStorage("postItUpdateView") var postItUpdateView = false
    
    @State var alertFailedToSyncData = false
    
    var body: some View {
        // ÂàóË°®
        NavigationView {
            //            ScrollView {
            //                LazyVStack {
            //
            //                }
            //            }
            ScrollView(showsIndicators: false) {
                LazyVStack {
//                    RoundedRectangle(cornerRadius: 40)
//                        .foregroundColor(Color("m1"))
//                        .padding(-16)
//                        .frame(height: 180)
//                        .offset(y: -50)
//                        .overlay(
//                            VStack {
//                                HStack {
//                                    postItToolButton(text: "È£≤È£üÂàÜÊûê")
//                                    postItToolButton(text: "ÂÖ±‰∫´‰ª£Ë≥º")
//                                    Spacer()
//
//                                }
//                                Spacer()
//                            }
//                        )
                    // ÂÜ∞ÁÆ±Ë≤ºÂÆπÈáè Êî∂Ë≤ªËß£Èéñ
                    BoxCalculateCapacity(count: calories, maxCount: 2500)
                    
                    // Ë®≠ÂÆö
                    HStack {
                        Spacer()
                        Button(action: {self.isSetting = true}) {
                            Image(systemName: "list.dash")
                        }
                        Button(action: {self.edit.toggle()}) {
                            Text(edit ? "done" : "Edit")
                        }
                    }
                    Spacer()
                        .frame(height: 20)
                    if isCreatingPostIt {
                        PostItCellLoading()
                    }
                    ForEach(DCpostIt, id: \.self) { item in
                        NavigationLink(destination: ComplexHome(postIt: item)) {
                            PostItCell(postItItem: item)
                                .overlay(   // Á∑®ËºØÂäüËÉΩ
                                    Group {
                                        if edit {
                                            Button(action: {
//                                                let dp : [PostIt] = decodedPostIt(self.postIt)
                                                let index = DCpostIt.firstIndex(of: item)!
                                                let postItID = DCpostIt[index].postItID
                                                if let index = DCpostIt.firstIndex(of: item) {
                                                    DCpostIt.remove(at: index)
                                                }
                                                NetworkAPI.deletePostIt(postItID: postItID) { result in
                                                    switch result {
                                                    case .success(_):
                                                        postItUpdateView = true
                                                    case let .failure(error):
                                                        print(error)
                                                    }
                                                }
                                            }) {
                                                Image(systemName: "xmark.circle.fill")
                                                    .resizable()
                                                    .scaledToFit()
                                                    .frame(width: 23, height: 23)
                                                    .foregroundColor(.red)
                                                    .shadow(color: .gray, radius: 20)
                                            }.offset(x: UIScreen.main.bounds.width/2 - 20, y: -40)
                                        }
                                    }
                                ).animation(.easeInOut)
                            //                                VStack(alignment: .leading) {
                            //                                    Text("\(item.label)")
                            //                                        .font(.headline)
                            //                                    Text("\(item.count)")
                            //                                        .font(.subheadline)
                            //                                    Text(item.create_time)
                            //                                        .font(.caption)
                            //                                        .foregroundColor(.gray)
                            //                                }
                        }
                    }
                    //                        .onDelete { index in
                    //                            let dp : [PostIt] = decodedPostIt(postIt)
                    //                            //                                dp.remove(at: index.first!)
                    //                            NetworkAPI.deletePostIt(postItID: dp[index.first!].postItID) { result in
                    //                                switch result {
                    //                                case .success(_):
                    //                                    NetworkAPI.getAllPostIt() { result in
                    //                                        switch result {
                    //                                        case let .success(data):
                    //                                            postIt = encodedPostIt(data)
                    //                                        case let .failure(error):
                    //                                            print(error)
                    //                                        }
                    //                                    }
                    //                                case let .failure(error):
                    //                                    print(error)
                    //                                }
                    //                            }
                    //                        }
                    //                        .onMove { source, destination in
                    //                            // ÔºÅÂæûÊï∏ÊìöÂ∫´Áç≤ÂèñÊéíÂàóÊï∏Êìö‰πãÊñπÊ≥ï
                    //                            var dp = decodedPostIt(self.postIts)
                    //                            dp.swapAt(source.first!, destination)
                    //                            self.postIts = encodedPostIt(dp)
                    //                        }
                }
                .padding()
                .listStyle(PlainListStyle()) // Ë≤ºÈΩä
                .navigationBarTitle("ÂÜ∞ÁÆ±Ë≤º", displayMode: .inline)
                .navigationBarHidden(true)
                //                    .navigationBarItems(trailing: EditButton())
                // ËÉåÊôØÈ°èËâ≤
                .background(Color(red: 250 / 255, green: 250 / 255, blue: 250 / 255))
            }
        }
        .edgesIgnoringSafeArea(.bottom)
        .onAppear {
            isCreatingPostIt = false
            //            resetDefaults()
            NetworkAPI.getAllPostIt() { result in
                switch result {
                case let .success(data):
                    calories = 0
                    for item in data {
                        calories = calories + (item.modelData?.calories ?? 0.0)
                    }
                    DCpostIt = data
                    self.postIt = encodedPostIt(data)
                case let .failure(error):
                    print(error)
                    self.alertFailedToSyncData = true
                }
            }
            // ÔºÅ ÂÅöÁÜ±ÈáèÂä†Ê∏õ Âú®ÈÄôÁï´Èù¢Áç≤Âèñ
            //            UDM.shared.getModelData(label: decodedPostIt(postIt)) { result in
            //                modelData = result
            //            }
        }
        .onChange(of: postItUpdateView, perform: { value in
            if value == true {
                NetworkAPI.getAllPostIt() { result in
                    switch result {
                    case let .success(data):
                        isCreatingPostIt = false
                        calories = 0
                        for item in data {
                            calories = calories + (item.modelData?.calories ?? 0.0)
                        }
                        DCpostIt = data
                        self.postIt = encodedPostIt(data)
                        postItUpdateView = false
                    case let .failure(error):
                        print(error)
                        self.alertFailedToSyncData = true
                        postItUpdateView = false
                    }
                }
            }
        })
        .alert(isPresented: $alertFailedToSyncData) {
            return Alert(title: Text("Âá∫ÁèæÂïèÈ°å"), message: Text("ÁÑ°Ê≥ïÈÄ≤Ë°åË≥áÊñôÂêåÊ≠•"))
        }
    }
}

struct PostItPage_Previews: PreviewProvider {
    static var previews: some View {
        PostItPage()
    }
}

// Êï∏ÊìöÁµêÊßã
struct PostItData: Identifiable, Codable {
    var id = UUID()
    var label : String
    var count : Int
    var date : String = getDate()
    var content : String
}

let postItDatas = [
    PostItData(label: "ÂèØÂè£ÂèØÊ®Ç", count: 6, date: "2020-01-01", content: """
ÊØè100ÊØ´Âçá ÂéüÂë≥ÂèØÂè£ÂèØÊ®Ç
ËÉΩÈáè    42ÂçÉÂç°
ËõãÁôΩË≥™    „ÄÄ0ÂÖã
Á∏ΩËÑÇËÇ™    0ÂÖã
È£ΩÂíåËÑÇËÇ™    0ÂÖã
ÂèçÂºèËÑÇËÇ™    0ÂÖã
Á¢≥Ê∞¥ÂåñÂêàÁâ©    10Èªû6ÂÖã
Á≥ñ    10Èªû6ÂÖã
Èàâ    4ÊØ´ÂÖã
"""),
    PostItData(label: "Áôæ‰∫ãÂèØÊ®Ç", count: 2, content: "ÈÄôÊòØ‰∏ÄÁì∂ÂèØÊ®Ç"),
    PostItData(label: "Ë•øËò≠Ëä±", count: 1, content: "ÈÄôÊòØ‰∏ÄÁì∂ÂèØÊ®Ç"),
    PostItData(label: "È∫•È¶ô", count: 1, content: "ÈÄôÊòØ‰∏ÄÁì∂ÂèØÊ®Ç"),
    PostItData(label: "ÈõûËõã", count: 12, content: "ÈÄôÊòØ‰∏ÄÁì∂ÂèØÊ®Ç"),
]



struct BoxCalculateCapacity: View {
    var count : Double
    var maxCount : Float
    var ratio : Float {
        Float(count) / maxCount < 0 ? 0 : Float(count) / maxCount > 1 ? 1 : Float(count) / maxCount
    }
    
    var body: some View {
        BoxView(
            width: .infinity,
            height: 100,
            color: Color.white,
            cornerRadius: 20,
            shadowColor: Color(red: 230 / 256, green: 230 / 256, blue: 230 / 256),
            shadowRadius: 60,
            shadowX: 0,
            shadowY: 0
        )
        .padding(.vertical, 30)
        .overlay(
            VStack {
                Spacer()
                Text("ÁÜ±Èáè")
                    .font(.system(size: 16))
                    .font(.system(size: 13))
                DataBarView(text: "\(count)", textSize: 10, textColor: Color.black, barColor: ratio >= 1 ? Color.red : Color.green, barBackgroundColor: Color(.systemGray5), barHeigth: 10, percent: CGFloat(ratio))
                if ratio >= 1 {
                    Text("„ÄåÊØèÊó•Âª∫Ë≠∞ÊîùÂèñÁÜ±Èáè2000Â§ßÂç°ÔºåË´ãÊ≥®ÊÑèÊéßÁÆ°„Äç")
                        .font(.system(size: 14))
                }
                Text("Êõ¥Â§öÂäüËÉΩÈúÄË¶Å‰ªòË≤ªËß£Èéñ")
                    .font(.caption)
                    .foregroundColor(.gray)
                Spacer()
            }
        )
    }
}



// Ê®°Âûã
let model = FoodModel41()

func performImageClassification(image: UIImage) -> String {
    if image == UIImage() {
        return "Ê≤íËÆä"
    }
    guard let buffer = image.resizeTo(size: CGSize(width: 299, height: 299)).toBuffer() else {
        return "ÂúñÂÉèÁÑ°Ê≥ïËΩâÊèõÂ§ßÂ∞è" 
    }
    let output = try? model.prediction(image: buffer)
    //        if let output = output {
    //            let results = output.classLabelProbs.sorted{$0.1 > $1.1}
    //
    //            let result = results.map { (key, value) in // ÂÖ®ÈÉ®ÁµêÊûúËÆäÊàê‰∏ÄÂÄãString
    //                return "\(key) = \(value * 100)%"
    //            }.joined(separator: "\n")
    //
    //            classificationLabel = result
    //        }
    if let output = output {
        //            self.postItList.append(output.classLabel.components(separatedBy: ",")[0])
        //        oldImage = image
        return output.classLabel.components(separatedBy: ",")[0]
    }
    return "Ê®°ÂûãÂá∫ÁèæÂïèÈ°å"
}

struct postItToolButton: View {
    let text : String
    var body: some View {
        RoundedRectangle(cornerRadius: 18)
            .foregroundColor(.white)
            .opacity(0.8)
            .frame(width: 60, height: 60)
            .shadow(radius: 45)
            .padding()
            .overlay(
                ZStack {
                    Text(text)
                        .foregroundColor(.white)
                        .font(.system(size: 12))
                        .offset(y: 50)
                    
                }
            )
    }
}
